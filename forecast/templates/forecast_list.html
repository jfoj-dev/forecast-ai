{% extends 'base.html' %}
{% load static %}

{% block title %}Previs√µes de Demanda{% endblock %}

{% block content %}
<div class="container-fluid mt-4">

  <!-- Cabe√ßalho -->
  <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3">
    <div>
      <h4 class="mb-0">üìà Previs√£o de Demanda</h4>
      <small class="text-muted">Vis√£o geral dos produtos e horizonte de 30 dias</small>
    </div>

    <div class="d-flex flex-wrap align-items-end gap-2">
      <form method="get" class="d-flex align-items-end gap-2">
        <div>
          <label for="start_date" class="form-label mb-1">In√≠cio</label>
          <input type="date" id="start_date" name="start_date"
                 class="form-control form-control-sm"
                 value="{{ start_date|date:'Y-m-d' }}">
        </div>
        <div>
          <label for="end_date" class="form-label mb-1">Fim</label>
          <input type="date" id="end_date" name="end_date"
                 class="form-control form-control-sm"
                 value="{{ end_date|date:'Y-m-d' }}">
        </div>
        <button type="submit" class="btn btn-outline-primary btn-sm mt-3">
          <i class="bi bi-funnel"></i> Filtrar
        </button>
      </form>

      <!-- Bot√µes de a√ß√£o -->
      <button id="train-btn" class="btn btn-warning mt-3">
        <i class="bi bi-hammer"></i> Treinar Modelo
      </button>

      <button id="generate-btn" class="btn btn-success mt-3">
        <i class="bi bi-graph-up"></i> Gerar Previs√µes
      </button>
      <button id="export-btn" class="btn btn-outline-secondary mt-3">
        <i class="bi bi-download"></i> Exportar CSV
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="row g-3 mb-4">
    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <div class="small text-muted">Total Previsto (30 dias)</div>
        <div class="fw-bold fs-4" id="kpi-total">{{ total_predicted|default_if_none:"0" }}</div>
        <div class="text-muted">MAPE m√©dio: <strong id="kpi-mape">{{ avg_mape|default_if_none:"-" }}%</strong></div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <div class="small text-muted">Produtos em risco</div>
        <div class="fw-bold fs-4 text-danger" id="kpi-risk">{{ products_risk|default_if_none:"0" }}</div>
        <div class="text-muted">(estoque &lt; previs√£o)</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <div class="small text-muted">Impacto de Promo√ß√µes</div>
        <div class="fw-bold fs-4" id="kpi-promo">{{ promo_impact|default_if_none:"0" }}%</div>
        <div class="text-muted">m√©dia nas vendas</div>
      </div>
    </div>

    <div class="col-md-3 col-sm-6">
      <div class="card shadow-sm p-3">
        <div class="small text-muted">√öltima atualiza√ß√£o</div>
        <div class="text-muted" id="kpi-updated">{{ last_update|default_if_none:"-" }}</div>
        <div class="mt-2">
          <button class="btn btn-sm btn-outline-primary">Ver hist√≥rico</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos -->
  <div class="row g-3 mb-4">
    <div class="col-lg-8">
      <div class="card shadow-sm p-3">
        <h6>Hist√≥rico vs Previs√£o</h6>
        <canvas id="lineChart" height="180"></canvas>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm p-3">
        <h6>Top demandas previstas (30d)</h6>
        <canvas id="barChart" height="180"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6>Promo√ß√£o vs Normal</h6>
        <canvas id="pieChart" height="150"></canvas>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm p-3">
        <h6>Sazonalidade mensal</h6>
        <div id="heatmap" class="d-flex flex-wrap gap-1 mt-2"></div>
        <small class="text-muted">Intensidade de vendas (escala de cor)</small>
      </div>
    </div>
  </div>

  <!-- Tabela -->
  <div class="card shadow-sm p-3">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Previs√µes por Produto</h6>
      <small class="text-muted">
        {% if start_date and end_date %}
          Per√≠odo: {{ start_date }} ‚Üí {{ end_date }}
        {% else %}
          Horizonte: 30 dias
        {% endif %}
      </small>
    </div>
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th>Produto</th>
            <th>Previsto (30d)</th>
            <th>Estoque</th>
            <th>Risco</th>
            <th>MAPE</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for f in forecasts %}
            <tr>
              <td>{{ f.product.title }}</td>
              <td>{{ f.predicted_quantity }}</td>
              <td>{{ f.product.quantity }}</td>
              <td>
                {% if f.product.quantity < f.predicted_quantity %}
                  <span class="badge bg-danger">Alto</span>
                {% else %}
                  <span class="badge bg-success">OK</span>
                {% endif %}
              </td>
              <td>{{ f.mape|default:"-" }}%</td>
              <td><button class="btn btn-sm btn-outline-primary">Ver</button></td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="text-center">Nenhuma previs√£o encontrada.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const barLabels = {{ chart_labels|safe|default:"[]" }};
const barData = {{ chart_data|safe|default:"[]" }};
const lineLabels = {{ line_labels|safe|default:"[]" }};
const lineReal = {{ line_real|safe|default:"[]" }};
const lineForecast = {{ line_forecast|safe|default:"[]" }};
const heatData = {{ heatmap|safe|default:"[]" }};
const promoCount = {{ promo_count|default:0 }};
const normalCount = {{ normal_count|default:0 }};

// Charts
if (barLabels.length && barData.length) {
  new Chart(document.getElementById('barChart'), {
    type: 'bar',
    data: { labels: barLabels, datasets: [{ data: barData, label: 'Previsto (30d)', backgroundColor: '#0d6efd' }] },
    options: { plugins: { legend: { display: false } } }
  });
}

if (document.getElementById('pieChart')) {
  new Chart(document.getElementById('pieChart'), {
    type: 'doughnut',
    data: { labels:['Promo√ß√£o','Normal'], datasets:[{data:[promoCount, normalCount], backgroundColor:['#ff6384','#36a2eb']}] },
    options:{plugins:{legend:{position:'bottom'}}}
  });
}

if (lineLabels.length && (lineReal.length || lineForecast.length)) {
  new Chart(document.getElementById('lineChart'), {
    type:'line',
    data:{
      labels: lineLabels,
      datasets:[
        { label:'Vendas reais', data:lineReal, borderColor:'#0d6efd', tension:0.3 },
        { label:'Previs√£o', data:lineForecast, borderColor:'#ff7b00', borderDash:[6,4], tension:0.3 }
      ]
    },
    options:{plugins:{legend:{position:'top'}}}
  });
}

if (document.getElementById('heatmap')) {
  const container = document.getElementById('heatmap');
  heatData.forEach(v=>{
    const el = document.createElement('div');
    el.style.width='calc(8.3% - 4px)';
    el.style.height='20px';
    el.style.borderRadius='4px';
    el.style.background=`hsl(210,70%,${90 - Math.min(80, v/1.2)}%)`;
    container.appendChild(el);
  });
}

// AJAX: gerar previs√µes
document.getElementById("generate-btn").addEventListener("click", async () => {
  const btn = document.getElementById("generate-btn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Gerando...';

  try {
    const response = await fetch("{% url 'generate_forecast' %}", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
    });
    const data = await response.json();

    if (data.success) {
      alert(data.message);
      location.reload();
    } else {
      alert("Erro: " + data.error);
    }
  } catch (err) {
    alert("Erro inesperado ao gerar previs√µes.");
  }

  btn.disabled = false;
  btn.innerHTML = '<i class="bi bi-graph-up"></i> Gerar Previs√µes';
});

// AJAX: exportar CSV
document.getElementById("export-btn").addEventListener("click", () => {
  const start = document.getElementById("start_date").value;
  const end = document.getElementById("end_date").value;
  window.location.href = `{% url 'export_forecast_csv' %}?start_date=${start}&end_date=${end}`;
});

// AJAX: treinar modelo
document.getElementById("train-btn").addEventListener("click", async () => {
  const btn = document.getElementById("train-btn");
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Treinando...';

  try {
    const response = await fetch("{% url 'train_forecast_model' %}", {
      method: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
    });
    const data = await response.json();

    if (data.success) {
      alert(data.message);
    } else {
      alert("Erro: " + data.error);
    }
  } catch (err) {
    alert("Erro inesperado ao treinar modelo.");
  }

  btn.disabled = false;
  btn.innerHTML = '<i class="bi bi-hammer"></i> Treinar Modelo';
});
</script>

{% endblock %}
